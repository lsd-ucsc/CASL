---
header-includes: |
    \usepackage{amssymb}
    \usepackage{bussproofs}
    \usepackage{xspace}

    \usepackage{amsthm}
    \newtheorem*{remark}{Remark}
    \newtheorem{definition}{Definition}[section]
    \newtheorem{theorem}{Theorem}[section]
    \newtheorem{axiom}[theorem]{Axiom}
    \newtheorem{lemma}[theorem]{Lemma}
    \newtheorem{corollary}{Corollary}[theorem]

title: Process-local causal delivery
...

This document lays out what we mean by process-local causal delivery.

## System model

\newcommand\uap{user application\xspace}
\newcommand\mpa{message passing algorithm\xspace}
\newcommand\proc{node\xspace}

\newcommand\Uap{User application\xspace}
\newcommand\Mpa{Message passing algorithm\xspace}
\newcommand\Proc{Node\xspace}

We model a distributed system as a finite set of $N$ \proc{}s, distinguished by
process identifier, which communicate by passing messages
over an asynchronous network.
\Proc{}s behave as though they are single threaded and are comprised of two
components: a \uap and a \mpa.
The \uap decides when to send messages, message content, and when to read
messages.
The \mpa handles sending messages via the network on behalf of the \uap,
receipt of messages from other \proc{}s on the network, and determining when
received messages are delivered (made available to be read by the \uap).
We regard the operation of \uap{}s as opaque and concern ourselves with the
behavior of the \mpa.

\newcommand\PID{\texttt{PID}\xspace}
\newcommand\MSG{\texttt{Message}\xspace}
\newcommand\EXE{\texttt{Execution}\xspace}

\begin{definition}[\PID]
Unique identifier $p$ for a \proc, $p:[1..N]$.
\end{definition}

\begin{definition}[\MSG]
Container for message content generated by a \uap and metadata generated
by the \mpa.
\end{definition}

A distributed system can be said to construct a trace of its execution as it
runs.
At each \proc the \uap generates send events, and the \mpa receives messages
from the network and eventually generates deliver events.
If each participant \proc were to accumulate this sequence of events in a local
history, the oracle view which associates each history with the \PID of its
\proc is called an \EXE.

\newcommand\EVENT{\texttt{Event}\xspace}
\newcommand\PHIST{\texttt{ProcessHistory}\xspace}

\begin{definition}[\EVENT]
A broadcast or a delivery of a \MSG, written $\text{broadcast}(m)$ to indicate
that the \MSG $m$ was sent, or $\text{deliver}_p(m)$ to indicate that the \MSG
$m$ was delivered at the \proc with \PID $p$.
We are only concerned with broadcast messages.
\end{definition}

\begin{definition}[\PHIST]
A sequence of the \EVENT{}s which occurred at the \proc with \PID $p$, written
$h_p$.
\end{definition}

\begin{definition}[\EXE]
A mapping from \PID to \PHIST comprising an oracle view of the global behavior
of a distributed system.
\end{definition}

\newcommand\hb{happens before\xspace}
\newcommand\po{process order\xspace}

\newcommand\Hb{Happens before\xspace}
\newcommand\Po{Process order\xspace}

\newcommand\hbarrmm[2]{#1 \rightarrow_{hb} #2}
\newcommand\poarrmm[3]{#2 \rightarrow_{#1} #3}

\newcommand\hbarr[2]{$\hbarrmm{#1}{#2}$}
\newcommand\poarr[3]{$\poarrmm{#1}{#2}{#3}$}

Given an \EXE of a distributed system, the \hb relation is the partial order
which includes all pairs of \EVENT{}s having a defined order.
The \po relation is a subset of the \hb relation which gives a total order to
all pairs of \EVENT{}s occurring in the same \PHIST.

\begin{definition}[\Po, (\poarr{p}{e}{e'})]
\label{po}
Given \EVENT{}s $e$ and $e'$ appearing in \PHIST $h_p$,
then writing \poarr{p}{e}{e'}
indicates that $e$ appears in the subsequence of $h_p$ prior to $e'$.
\end{definition}

\begin{definition}[\Hb, (\hbarr{e}{e'})]
\label{hb}
Given \EVENT{}s $e$ and $e'$ appearing in \EXE $x$,
then writing \hbarr{e}{e'}
indicates one of the following conditions:
\begin{itemize}
\item
        \poarr{p}{e}{e'} (Def. \ref{po}) for some
        \PID $p$ in the domain of $x$.
\item   $e$ is $\text{broadcast}(m)$ and
        $e'$ is $\text{deliver}_p(m)$ for some
        \MSG $m$ in $x$ and some
        \PID $p$ in the domain of $x$.
\item
        \hbarr{e}{e''} and \hbarr{e''}{e'} for some
        \EVENT $e''$ also appearing in $x$.
\end{itemize}
\end{definition}

We may occasionally use a shorthand for \MSG{}s, \hbarr{m}{m'}, to
relate the \EVENT{}s \hbarr{\text{broadcast}(m)}{\text{broadcast}(m')}.

## Causal Delivery

\newcommand\cd{causal delivery\xspace}
\newcommand\Cd{Causal delivery\xspace}

An \EXE observes \cd when \proc{}s deliver messages in an order consistent with
the \hb partial order.

\begin{definition}[\Cd]
\label{cd}
An \EXE $x$ observes \cd if, given
    \PID{}s $p$, $q$, and $r$ in the domain of $x$ and
    \MSG{}s $m$, and $m'$ where
        $\text{broadcast}(m )$ occurs in $h_q$,
        $\text{broadcast}(m')$ occurs in $h_r$,
        $\text{deliver}_p(m )$ occurs in $h_p$, and
        $\text{deliver}_p(m')$ occurs in $h_p$,
it follows that
$$\begin{aligned}
                \hbarrmm{\text{broadcast}(m)}{\text{broadcast}(m')}
    \implies    \poarrmm{p}{\text{deliver}_p(m)}{\text{deliver}_p(m')}
\end{aligned}$$
\end{definition}


\newcommand\vc{vector clock\xspace}
\newcommand\Vc{Vector clock\xspace}

\newcommand\vcless{\vc less\xspace}
\newcommand\Vcless{\Vc less\xspace}

\newcommand\vcltmm[2]{#1 <_{vc} #2}
\newcommand\vclt[2]{$\vcltmm{#1}{#2}$}

\newcommand\vchbc{VC-HB copacetic\xspace}

We'd like a bridge from discussion of whole \EXE{}s to the behavior of a single
\proc. We'll build that bridge using \vc{}s.

### Vector Clocks

A \vc is a vector of natural numbers with length $N$ (the number of \proc{}s)
indexed by \PID.
We write $VC(k)$ to indicate the \vc for some object $k$ which may be a \proc,
a \MSG, or an \EVENT (indicating the \proc \vc when the \EVENT was added to a
\PHIST)^[Leave this detail out?].
The \vcless relation is a partial order on \vc{}s.

\begin{definition}[\Vcless, (\vclt{v}{v'})]
\label{vclt}
Given \vc{}s $v$ and $v'$, then writing \vclt{v}{v'} indicates that
$\forall i. v[i] \leq v'[i]$ and
$\exists i. v[i] \neq v'[i]$.
\end{definition}

A \mpa using \vc{}s typically maintains a single \proc \vc to include in
metadata of outgoing \MSG{}s.
A \mpa may model the \hb relation using \vc{}s via the \vcless relation by
precisely constructing \vc{}s over the course of an \EXE.

\begin{definition}[\vchbc]
\label{vchbc}
An \EXE $x$ is \vchbc if, given
    \PID{}s $q$ and $r$ in the domain of $x$ and
    \EVENT{}s $e$ and $e'$ where
        $e$ occurs in $h_q$ and
        $e'$ occurs in $h_r$,
it follows that
$$\begin{aligned}
            \vcltmm{VC(e)}{VC(e')}
    \iff    \hbarrmm{e}{e'}
\end{aligned}$$
\end{definition}

### Process-local Causal Delivery

\newcommand\plcd{process-local causal delivery\xspace}
\newcommand\Plcd{Process-local causal delivery\xspace}

A \PHIST observes \plcd when the \proc delivers messages in an order consistent
with the \hb relation partial order.

\begin{definition}[\Plcd]
\label{plcd}
A \PHIST $h_p$ observes \plcd if, given
    \MSG{}s $m$ and $m'$ where
        $\text{deliver}_p(m)$ and $\text{deliver}_p(m')$ occur in $h_p$,
it follows that
$$\begin{aligned}
                \vcltmm{VC(\text{broadcast}(m))}{VC(\text{broadcast}(m'))}
    \implies    \poarrmm{p}{\text{deliver}_p(m)}{\text{deliver}_p(m')}
\end{aligned}$$
\end{definition}

\begin{theorem}[\Plcd implies \Cd]
\label{plcd-cd}
If \proc{}s observe \plcd (Def. \ref{plcd}) and
the \EXE is \vchbc (Def. \ref{vchbc}), then
the \EXE observes \cd (Def. \ref{cd}).
\end{theorem}

Proof: \vchbc couples the delivery order in \plcd observing \proc{}s to the \hb
partial order required for the \EXE to be \cd. \qed

## CBCAST

CBCAST is a \mpa we care about.
We'll take as an axiom that \EXE{}s produced by runs of CBCAST are \vchbc.

\begin{axiom}[Vector Clock Isomorphism]
\label{cbcast-vchbc}
If \proc{}s are running CBCAST then the \EXE is \vchbc (Def. \ref{vchbc}).
\end{axiom}

Proof: Gan and Simon's work. \qed

\begin{lemma}[CBCAST observes \Plcd]
\label{cbcast-plcd}
A \proc running CBCAST will produce a \PHIST which observes \plcd (Def. \ref{plcd}).
\end{lemma}

* Messages go into the delay queue.
* Messages come out of the delay queue in VC-order.
* No messages are ever skipped.

\begin{theorem}[CBCAST observes \Cd]
\label{cbcast-cd}
If \proc{}s are running CBCAST then the \EXE observes \cd (Def. \ref{cd}).
\end{theorem}

Proof: Axiom \ref{cbcast-vchbc} and Lemma \ref{cbcast-plcd} satisfy the premises of Theorem \ref{plcd-cd}. \qed

---

# Other things

Executions produced by CBCAST have the following additional properties,
probably:

* Messages are never delivered before they are sent.
* The \PID $p$ on every Event $deliver_p(m)$ in a ProcessHistory $h_p$
  is the same $p$ which maps to $h_p$ from the Execution $x$ via $x[p]$.
* The \PID $p$ mapping to a ProcessHistory $x[p]$ in the Execution $x$
  must be the \PID on every $deliver_p(m)$ in that ProcessHistory.
* TODO: select one of the two above; they say the same thing differently.

Variable names should follow this convention:

* $x$, $y$, and $z$ are Executions.
* $p$, $q$, and $r$ are \PID.
* $m$, $m'$, $m_1$, and $m_2$ are Messages.
* $e$, $e'$, $e_1$, and $e_2$ are Events.
